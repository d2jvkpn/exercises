### Exercises
---

#### 1. Create hello pods
```bash
kubectl create ns dev
kubectl get ns/dev

kubectl -n dev run --image=registry.cn-shanghai.aliyuncs.com/d2jvkpn/hello:latest \
  --port=8080 --env=TZ=Asia/Shanghai hello-01

kubectl -n dev get pod/hello-01
kubectl -n dev get pod/hello-01 -o yaml
kubectl -n dev label pod/hello-01 app=hello

cat | kubectl apply -f - << EOF
apiVersion: v1
kind: Pod
metadata:
  namespace: dev
  name: hello-02
  labels: {  app: hello }
spec:
  containers:
  - name: hello-02
    image: registry.cn-shanghai.aliyuncs.com/d2jvkpn/hello:latest
    ports:
    - { containerPort: 8080, protocol: TCP }
    env:
    - {name: TZ, value: Asia/Shanghai}
EOF

kubectl -n dev get pod/hello-02
# kubectl -n dev delete pod/hello-02
kubectl -n dev label pod/hello-02 app=hello

kubectl -n dev get pods --field-selector status.phase=Running

kubectl -n dev get pods --selector app=hello
kubectl -n dev exec -it pod/hello-02 -- sh
```

#### 2. Create hello deployment
```bash
cat | kubectl apply -f - <<EOF
apiVersion: apps/v1
kind: Deployment
metadata:
  namespace: dev
  name: hello
  labels: { app: "hello" }

spec:
  replicas: 3
  selector:
    matchLabels: { app: "hello" }
  template:
    metadata:
      labels: { app: "hello" }
    spec:
      containers:
      - name: hello
        image: registry.cn-shanghai.aliyuncs.com/d2jvkpn/hello:latest
        # IfNotPresent, Always, Never
        imagePullPolicy: "IfNotPresent"

        env:
        - name: POD_NAME
          valueFrom: { fieldRef: { apiVersion: "v1", fieldPath: "metadata.name" } }
        - { name: TZ, value: Asia/Shanghai }

        ports:
        - { name: "http", containerPort: 8080, protocol: "TCP" }

        # command: [tail, -f, /etc/hosts]
        command: ["./main"]
        args: [ "--port=8080", "--release"]
EOF

kubectl -n dev get deploy/hello
```

#### 3. Create hello service
```bash
cat | kubectl apply -f - << EOF
apiVersion: v1
kind: Service
metadata:
  namespace: dev
  name: hello
spec:
  type: ClusterIP
  clusterIP: 10.107.98.176
  ports:
  - { targetPort: 8080, port: 8080 }
  selector: { app: hello }
EOF

kubectl -n dev get service/hello

curl -i 10.107.98.176:8080
```

```bash
kubectl -n dev get pods -o json |
  jq -r '.items[].status.containerStatuses[] | [.name, .image, .imageID] | @tsv'

kubectl -n dev get pods/hello-01 -o json |
  jq -r '.status.containerStatuses[] | [.name, .image, .imageID] | @tsv'
```

#### 4. Update image of a deployment or pod
```bash
kubectl -n dev set image deploy/hello hello=registry.cn-shanghai.aliyuncs.com/d2jvkpn/hello:latest@xxxx
kubectl -n dev set image pod/hello-01 hello-01=registry.cn-shanghai.aliyuncs.com/d2jvkpn/hello:latest@xxxx
```

#### 5. Remove exited containers
crictl ps -a -o json |
  jq -r '.containers[] | select(.state=="CONTAINER_EXITED") | .id' |
  xargs -i crictl rm {}
